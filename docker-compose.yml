services:
  dicom-anonymizer:
    build: .
    container_name: ${CONTAINER_NAME:-Dicom-Anonymizer}
    labels:
        com.docker.compose.project: "${COMPOSE_PROJECT_NAME:-docker}"
    volumes:
      # Mount directories for persistent storage (optional)
      - dicom_uploads:/app/temp_uploads
      - dicom_outputs:/app/temp_outputs
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - FLASK_APP=${FLASK_APP:-app.py}
      # Azure AD / Entra ID SSO configuration
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID:-}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID:-}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET:-}
      - AZURE_REDIRECT_PATH=${AZURE_REDIRECT_PATH:-/auth/callback}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-fallback-secret-key}
      # Session configuration (authentication vs file storage timeouts)
      - SESSION_TIMEOUT_MINUTES=${SESSION_TIMEOUT_MINUTES:-60}
      - SESSION_FILE_TIMEOUT_MINUTES=${SESSION_FILE_TIMEOUT_MINUTES:-30}
      # Concurrent session limits and performance
      - MAX_SESSIONS_PER_USER=${MAX_SESSIONS_PER_USER:-3}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ANONYMOUS_RATE_LIMIT=${ANONYMOUS_RATE_LIMIT:-10}
      # Add additional Flask production settings
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - PYTHONDONTWRITEBYTECODE=${PYTHONDONTWRITEBYTECODE:-1}
    restart: ${RESTART_POLICY:-unless-stopped}
    # Uncomment for direct access testing
    # ports:
    #   - "${APP_PORT:-5000}:5000"
    networks:
      - nginx_lan
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-40s}

# Storage volumes - 20GB total capacity with automatic management
# - 12GB for uploads (3GB max per session, multiple concurrent sessions)
# - 8GB for outputs (anonymized files before download)
# Files are automatically cleaned up after 30 minutes or on user logout
volumes:
  dicom_uploads:
    driver: ${VOLUME_DRIVER:-local}
    driver_opts:
      type: ${VOLUME_TYPE:-tmpfs}
      device: ${VOLUME_DEVICE:-tmpfs}
      o: ${VOLUME_OPTIONS:-size=12G,noexec,nosuid,nodev}
  dicom_outputs:
    driver: ${VOLUME_DRIVER:-local}
    driver_opts:
      type: ${VOLUME_TYPE:-tmpfs}
      device: ${VOLUME_DEVICE:-tmpfs}
      o: ${VOLUME_OPTIONS:-size=8G,noexec,nosuid,nodev}

networks:
  nginx_lan:
    external: ${NGINX_NETWORK_EXTERNAL:-true}
