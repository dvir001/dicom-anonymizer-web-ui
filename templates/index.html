<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Anonymizer</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .container.locked {
            filter: blur(3px);
            pointer-events: none;
            user-select: none;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .session-status {
            font-size: 0.95em;
            color: #0c5460;
            background: #d1ecf1;
            padding: 6px 12px;
            border-radius: 20px;
        }

        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(13, 27, 43, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-overlay.hidden {
            display: none !important;
        }

        .login-modal {
            background: #ffffff;
            border-radius: 12px;
            padding: 30px;
            width: min(420px, 90%);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
            text-align: center;
        }

        .login-modal h2 {
            margin: 0 0 10px;
            color: #1f2933;
        }

        .login-modal p {
            margin: 0 0 20px;
            color: #4a5568;
            line-height: 1.4;
        }

        .login-modal form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .login-modal input[type="password"] {
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            font-size: 16px;
        }

        .login-modal input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .login-modal button {
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #ffffff;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .login-modal button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.35);
        }

        .login-modal button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-error {
            margin-top: 12px;
            padding: 10px 12px;
            background: #fdecea;
            color: #c53030;
            border-radius: 8px;
            font-size: 0.95em;
        }

        body.modal-open {
            overflow: hidden;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 300;
        }

        /* Tab System Styles */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-list {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            background: #e9ecef;
        }

        .tab-button.active {
            background: white;
            color: #007bff;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }

        .tab-button .close-tab {
            margin-left: 10px;
            color: #999;
            cursor: pointer;
            font-weight: bold;
        }

        .tab-button .close-tab:hover {
            color: #dc3545;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .new-tab-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .new-tab-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        /* File Batch System */
        .batch-info {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .batch-info h4 {
            margin-top: 0;
            color: #0c5460;
        }

        .batch-files-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .upload-area {
            border: 3px dashed #ddd;
            padding: 60px 20px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
            background: #fafafa;
        }

        .upload-area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .upload-area:hover:not(.disabled),
        .upload-area.drag-over {
            border-color: #007bff;
            background: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
        }

        .upload-area.drag-active {
            border-color: #28a745;
            background: #f0fff0;
            border-style: solid;
        }

        .upload-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .upload-icon {
            font-size: 3em;
            color: #007bff;
            margin-bottom: 15px;
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.secondary {
            background: linear-gradient(135deg, #6c757d, #545b62);
        }

        .btn.success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .btn.warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }

        .hidden {
            display: none !important;
        }

        .file-item {
            padding: 15px;
            background: #f8f9fa;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .file-item.dicom {
            border-left: 4px solid #28a745;
            background: linear-gradient(90deg, #d4edda, #f8f9fa);
        }

        .file-item.non-dicom {
            border-left: 4px solid #ffc107;
            background: linear-gradient(90deg, #fff3cd, #f8f9fa);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .badge.dicom {
            background: #28a745;
            color: white;
        }

        .badge.non-dicom {
            background: #ffc107;
            color: #000;
        }

        .status {
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box h4 {
            margin-top: 0;
            color: #1976d2;
            font-weight: 500;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .cleanup-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 15px;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        .radio-group {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .radio-option {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .radio-option:hover {
            background: #e9ecef;
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
        }

        .radio-option label {
            cursor: pointer;
            font-weight: 500;
        }

        .radio-option small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-style: italic;
        }

        .checkbox-option {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            background: #f1f3f4;
        }

        .checkbox-option label {
            cursor: pointer;
            font-weight: 500;
        }

        /* Directory structure display */
        .directory-tree {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .directory-item {
            margin: 5px 0;
            padding-left: 20px;
        }

        .directory-folder {
            color: #0066cc;
            font-weight: bold;
        }

        .directory-file {
            color: #333;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay{% if is_authenticated %} hidden{% endif %}">
        <div class="login-modal">
            <h2>🔐 Secure Access Required</h2>
            <p>Enter the administrator password to manage anonymization tasks.</p>
            <form id="loginForm">
                <input type="password" id="loginPassword" name="password" placeholder="Admin password" autocomplete="current-password" required>
                <button type="submit" id="loginButton">Unlock</button>
            </form>
            <div id="loginError" class="login-error hidden"></div>
        </div>
    </div>

    <div id="appContainer" class="container{% if not is_authenticated %} locked{% endif %}">
        <div class="top-bar">
            <span id="sessionStatus" class="session-status{% if not is_authenticated %} hidden{% endif %}">🔓 Session active</span>
            <button id="logoutButton" type="button" class="btn secondary{% if not is_authenticated %} hidden{% endif %}">🚪 Logout</button>
        </div>
        <h1>🏥 DICOM Anonymizer - Batch Processing</h1>

        <div class="info-box">
            <h4>📋 About DICOM Anonymizer</h4>
            <p>A secure web-based tool for anonymizing DICOM medical imaging files while preserving essential metadata.</p>
            <ul>
                <li><strong>Two Anonymization Modes:</strong>
                    <ul>
                        <li>Minimal - Only removes patient names, IDs, and study IDs</li>
                        <li>Standard - Comprehensive DICOM anonymization following industry standards</li>
                    </ul>
                </li>
                <li><strong>File Support:</strong> Accepts any file type (up to 3GB per session) - DICOM files are automatically detected by content</li>
                <li><strong>ZIP Archives:</strong> Automatically extracts and processes DICOM files from ZIP archives</li>
                <li><strong>Batch Processing:</strong> Upload multiple files at once, add more before processing</li>
                <li><strong>Structure Preservation:</strong> Maintains original folder hierarchy in anonymized output</li>
                <li><strong>Auto-Cleanup:</strong> Files are automatically deleted after 30 minutes or when you logout</li>
                <li><strong>Storage Management:</strong> 20GB total storage with automatic space management</li>
            </ul>
        </div>

        <div class="tab-container">
            <div class="tab-list" id="tabList">
                <button class="tab-button active" data-tab="tab-1" onclick="switchTab('tab-1')">
                    Batch 1 <span class="close-tab" onclick="closeTab(event, 'tab-1')">×</span>
                </button>
                <button class="new-tab-button" onclick="createNewTab()">+ New Batch</button>
            </div>

            <div id="tab-1" class="tab-content active">
                <div class="batch-info hidden" id="batchInfo-tab-1">
                    <h4>📦 Current Batch</h4>
                    <div id="batchStats-tab-1"></div>
                    <div class="batch-files-list" id="batchFilesList-tab-1"></div>
                </div>

                <div class="upload-area" id="uploadArea-tab-1">
                    <div class="upload-icon">📁</div>
                    <h3>📤 Upload Files to Batch</h3>
                    <p>Click to select files, drag and drop, or choose a folder</p>
                    <p><small>You can add more files before starting anonymization</small></p>
                    <div class="upload-controls">
                        <button type="button" class="btn secondary" id="selectFiles-tab-1">📁 Select Files</button>
                        <button type="button" class="btn secondary" id="selectFolder-tab-1">📂 Select Folder</button>
                    </div>
                    <input type="file" id="fileInputFiles-tab-1" multiple style="display: none;">
                    <input type="file" id="fileInputFolder-tab-1" multiple webkitdirectory directory style="display: none;">
                </div>

                <div id="uploadProgress-tab-1" class="hidden">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill-tab-1"></div>
                    </div>
                    <p id="progressText-tab-1" style="text-align: center; color: #666;">Uploading files...</p>
                </div>

                <div id="fileList-tab-1" class="hidden"></div>
                <div id="uploadStatus-tab-1" class="hidden"></div>

                <div id="optionsCard-tab-1" class="hidden">
                    <h3>⚙️ Anonymization Options</h3>
                    
                    <h4>🛡️ Anonymization Mode</h4>
                    <div style="margin: 15px 0;">
                        <div style="margin: 10px 0;">
                            <input type="radio" id="minimalMode-tab-1" name="anonymizationMode-tab-1" value="minimal" checked>
                            <label for="minimalMode-tab-1">Custom Minimal Anonymization</label>
                            <br><small>Only anonymizes names, Patient ID, and Study ID</small>
                        </div>
                        
                        <div style="margin: 10px 0;">
                            <input type="radio" id="standardMode-tab-1" name="anonymizationMode-tab-1" value="standard">
                            <label for="standardMode-tab-1">Standard Full Anonymization</label>
                            <br><small>Applies comprehensive DICOM anonymization rules</small>
                        </div>
                    </div>

                    <div id="standardOptions-tab-1" style="display: none;">
                        <label>
                            <input type="checkbox" id="keepPrivateTags-tab-1" checked> Keep private DICOM tags
                        </label>
                        <p><small>Private tags will be preserved. Uncheck to remove private tags for maximum anonymization</small></p>
                    </div>

                    <div class="button-group">
                        <button id="addMoreBtn-tab-1" class="btn warning" onclick="enableUploadForTab('tab-1')">📁 Add More Files</button>
                        <button id="anonymizeBtn-tab-1" class="btn" onclick="startAnonymization('tab-1')">🔒 Start Anonymization</button>
                    </div>
                </div>

                <div id="resultsCard-tab-1" class="hidden">
                    <h3>✅ Anonymization Complete</h3>
                    <div id="resultsStatus-tab-1"></div>
                    <button id="downloadBtn-tab-1" class="btn">📥 Download Anonymized Files</button>
                    <button class="btn" onclick="startOver('tab-1')">🔄 Start New Batch</button>

                    <div class="cleanup-info">
                        <p><strong>Note:</strong> Files will be automatically deleted from the server after 30 minutes or when you logout for security.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script id="appConfigPayload" type="application/json">
        {{ {
            'authenticated': is_authenticated,
            'sessionTimeoutMinutes': session_timeout_minutes,
            'sessionRemainingSeconds': session_remaining_seconds,
            'loginLockoutSeconds': login_lockout_duration,
            'maxLoginAttempts': max_login_attempts,
            'existingSessions': existing_sessions
        } | tojson }}
    </script>

    <script>
    const appConfig = JSON.parse(document.getElementById('appConfigPayload').textContent);
    appConfig.existingSessions = Array.isArray(appConfig.existingSessions) ? appConfig.existingSessions : [];

        const loginOverlay = document.getElementById('loginOverlay');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const sessionStatus = document.getElementById('sessionStatus');

        function createEmptyTabState() {
            return {
                sessionId: null,
                outputSessionId: null,
                uploadEnabled: true,
                files: [],
                totalDicomCount: 0
            };
        }

        const tabStates = {
            'tab-1': createEmptyTabState()
        };

        let activeTab = 'tab-1';
        let tabCounter = 1;

        function updateSessionUI(isAuthenticated) {
            if (sessionStatus) {
                if (isAuthenticated) {
                    sessionStatus.classList.remove('hidden');
                    sessionStatus.textContent = '🔓 Session active';
                } else {
                    sessionStatus.classList.add('hidden');
                }
            }

            if (logoutButton) {
                logoutButton.classList.toggle('hidden', !isAuthenticated);
                logoutButton.disabled = false;
            }
        }

        function lockInterface(message) {
            if (loginOverlay) {
                loginOverlay.classList.remove('hidden');
            }

            if (appContainer) {
                appContainer.classList.add('locked');
            }

            document.body.classList.add('modal-open');

            if (loginError) {
                if (message) {
                    loginError.textContent = message;
                    loginError.classList.remove('hidden');
                } else {
                    loginError.textContent = '';
                    loginError.classList.add('hidden');
                }
            }

            if (loginButton) {
                loginButton.disabled = false;
                loginButton.textContent = 'Unlock';
            }

            if (logoutButton) {
                logoutButton.disabled = false;
            }

            if (loginPasswordInput) {
                loginPasswordInput.value = '';
                loginPasswordInput.focus();
            }

            appConfig.authenticated = false;
            updateSessionUI(false);
            resetAllTabs();
        }

        function unlockInterface() {
            if (loginOverlay) {
                loginOverlay.classList.add('hidden');
            }

            if (appContainer) {
                appContainer.classList.remove('locked');
            }

            document.body.classList.remove('modal-open');

            if (loginError) {
                loginError.textContent = '';
                loginError.classList.add('hidden');
            }

            appConfig.authenticated = true;
            updateSessionUI(true);
        }

        async function parseJsonResponse(response, unauthorizedMessage) {
            if (response.status === 401) {
                const payload = await response.json().catch(() => ({}));
                const message = (payload && payload.error) || unauthorizedMessage || 'Authentication required.';
                lockInterface(message);
                return null;
            }

            return response.json();
        }

        if (!appConfig.authenticated) {
            lockInterface();
        } else {
            updateSessionUI(true);
        }

        if (loginForm) {
            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (!loginPasswordInput) {
                    return;
                }

                const password = loginPasswordInput.value.trim();
                if (!password) {
                    lockInterface('Password is required.');
                    return;
                }

                loginButton.disabled = true;
                loginButton.textContent = 'Unlocking...';

                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ password })
                    });

                    const result = await response.json().catch(() => ({}));

                    if (response.ok && result && result.success) {
                        unlockInterface();
                        loginPasswordInput.value = '';
                    } else {
                        const message = (result && result.error) || 'Login failed. Please try again.';
                        lockInterface(message);
                    }
                } catch (error) {
                    lockInterface(`Unable to login: ${error.message}`);
                } finally {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Unlock';
                }
            });
        }

        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                logoutButton.disabled = true;

                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        lockInterface('You have been logged out. Please login to continue.');
                    } else {
                        logoutButton.disabled = false;
                    }
                } catch (error) {
                    logoutButton.disabled = false;
                }
            });
        }

        // Tab management functions
        function createNewTab() {
            tabCounter++;
            const tabId = `tab-${tabCounter}`;
            
            // Initialize tab state
            tabStates[tabId] = createEmptyTabState();

            // Create tab button
            const tabButton = document.createElement('button');
            tabButton.className = 'tab-button';
            tabButton.dataset.tab = tabId;
            tabButton.innerHTML = `Batch ${tabCounter} <span class="close-tab" onclick="closeTab(event, '${tabId}')">×</span>`;
            tabButton.onclick = () => switchTab(tabId);

            // Insert before the "New Tab" button
            const newTabButton = document.querySelector('.new-tab-button');
            newTabButton.parentNode.insertBefore(tabButton, newTabButton);

            // Create tab content - build from scratch instead of cloning
            const newTabContent = document.createElement('div');
            newTabContent.id = tabId;
            newTabContent.className = 'tab-content';
            
            // Build the tab content HTML
            newTabContent.innerHTML = `
                <div class="batch-info hidden" id="batchInfo-${tabId}">
                    <h4>📦 Current Batch</h4>
                    <div id="batchStats-${tabId}"></div>
                    <div class="batch-files-list" id="batchFilesList-${tabId}"></div>
                </div>

                <div class="upload-area" id="uploadArea-${tabId}">
                    <div class="upload-icon">📁</div>
                    <h3>📤 Upload Files to Batch</h3>
                    <p>Click to select files, drag and drop, or choose a folder</p>
                    <p><small>You can add more files before starting anonymization</small></p>
                    <div class="upload-controls">
                        <button type="button" class="btn secondary" id="selectFiles-${tabId}">📁 Select Files</button>
                        <button type="button" class="btn secondary" id="selectFolder-${tabId}">📂 Select Folder</button>
                    </div>
                    <input type="file" id="fileInputFiles-${tabId}" multiple style="display: none;">
                    <input type="file" id="fileInputFolder-${tabId}" multiple webkitdirectory directory style="display: none;">
                </div>

                <div id="uploadProgress-${tabId}" class="hidden">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill-${tabId}"></div>
                    </div>
                    <p id="progressText-${tabId}" style="text-align: center; color: #666;">Uploading files...</p>
                </div>

                <div id="fileList-${tabId}" class="hidden"></div>
                <div id="uploadStatus-${tabId}" class="hidden"></div>

                <div id="optionsCard-${tabId}" class="hidden">
                    <h3>⚙️ Anonymization Options</h3>
                    
                    <h4>🛡️ Anonymization Mode</h4>
                    <div style="margin: 15px 0;">
                        <div style="margin: 10px 0;">
                            <input type="radio" id="minimalMode-${tabId}" name="anonymizationMode-${tabId}" value="minimal" checked>
                            <label for="minimalMode-${tabId}">Custom Minimal Anonymization</label>
                            <br><small>Only anonymizes names, Patient ID, and Study ID</small>
                        </div>
                        
                        <div style="margin: 10px 0;">
                            <input type="radio" id="standardMode-${tabId}" name="anonymizationMode-${tabId}" value="standard">
                            <label for="standardMode-${tabId}">Standard Full Anonymization</label>
                            <br><small>Applies comprehensive DICOM anonymization rules</small>
                        </div>
                    </div>

                    <div id="standardOptions-${tabId}" style="display: none;">
                        <label>
                            <input type="checkbox" id="keepPrivateTags-${tabId}" checked> Keep private DICOM tags
                        </label>
                        <p><small>Private tags will be preserved. Uncheck to remove private tags for maximum anonymization</small></p>
                    </div>

                    <div class="button-group">
                        <button id="addMoreBtn-${tabId}" class="btn warning" onclick="enableUploadForTab('${tabId}')">📁 Add More Files</button>
                        <button id="anonymizeBtn-${tabId}" class="btn" onclick="startAnonymization('${tabId}')">🔒 Start Anonymization</button>
                    </div>
                </div>

                <div id="resultsCard-${tabId}" class="hidden">
                    <h3>✅ Anonymization Complete</h3>
                    <div id="resultsStatus-${tabId}"></div>
                    <button id="downloadBtn-${tabId}" class="btn">📥 Download Anonymized Files</button>
                    <button class="btn" onclick="startOver('${tabId}')">🔄 Start New Batch</button>

                    <div class="cleanup-info">
                        <p><strong>Note:</strong> Files will be automatically deleted from the server after 30 minutes or when you logout for security.</p>
                    </div>
                </div>
            `;
            
            // Add to container
            document.querySelector('.tab-container').appendChild(newTabContent);
            
            // Setup event handlers for the new tab
            setupTabEventHandlers(tabId);
            
            // Switch to new tab
            switchTab(tabId);
            
            // Show initial status
            showStatus('🚀 Ready to upload DICOM files. Drag and drop or click to select files.', 'info', tabId);

            return tabId;
        }

        function resetAllTabs() {
            // Remove any dynamically added tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.dataset && button.dataset.tab !== 'tab-1') {
                    button.remove();
                } else if (button.dataset && button.dataset.tab === 'tab-1') {
                    button.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id !== 'tab-1') {
                    content.remove();
                } else {
                    content.classList.add('active');
                }
            });

            // Reset counters and state
            tabCounter = 1;
            activeTab = 'tab-1';
            Object.keys(tabStates).forEach(tabId => {
                if (tabId !== 'tab-1') {
                    delete tabStates[tabId];
                }
            });
            tabStates['tab-1'] = createEmptyTabState();
            appConfig.existingSessions = [];

            const tabOne = document.getElementById('tab-1');
            if (tabOne) {
                resetTabContent(tabOne, 'tab-1');
            }

            showStatus('🚀 Ready to upload DICOM files. Drag and drop or click to select files.', 'info', 'tab-1');
        }

        function updateElementIds(element, tabId) {
            // Update all elements with IDs
            const elementsWithIds = element.querySelectorAll('[id]');
            elementsWithIds.forEach(el => {
                const baseId = el.id.replace(/-tab-\d+/, '');
                el.id = `${baseId}-${tabId}`;
            });

            // Update radio button names
            const radioButtons = element.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                const baseName = radio.name.replace(/-tab-\d+/, '');
                radio.name = `${baseName}-${tabId}`;
            });

            // Update labels
            const labels = element.querySelectorAll('label[for]');
            labels.forEach(label => {
                const baseFor = label.getAttribute('for').replace(/-tab-\d+/, '');
                label.setAttribute('for', `${baseFor}-${tabId}`);
            });

            // Update onclick handlers
            const buttons = element.querySelectorAll('button[onclick]');
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                if (onclick) {
                    button.setAttribute('onclick', onclick.replace(/tab-\d+/g, tabId));
                }
            });
        }

        function resetTabContent(tabContent, tabId) {
            // Hide all sections except upload area
            const batchInfo = tabContent.querySelector(`#batchInfo-${tabId}`);
            const fileList = tabContent.querySelector(`#fileList-${tabId}`);
            const uploadStatus = tabContent.querySelector(`#uploadStatus-${tabId}`);
            const uploadProgress = tabContent.querySelector(`#uploadProgress-${tabId}`);
            const optionsCard = tabContent.querySelector(`#optionsCard-${tabId}`);
            const resultsCard = tabContent.querySelector(`#resultsCard-${tabId}`);
            
            if (batchInfo) batchInfo.classList.add('hidden');
            if (fileList) fileList.classList.add('hidden');
            if (uploadStatus) uploadStatus.classList.add('hidden');
            if (uploadProgress) uploadProgress.classList.add('hidden');
            if (optionsCard) optionsCard.classList.add('hidden');
            if (resultsCard) resultsCard.classList.add('hidden');
            
            // Enable upload area
            const uploadArea = tabContent.querySelector(`#uploadArea-${tabId}`);
            if (uploadArea) {
                uploadArea.classList.remove('disabled');
            }
            
            // Reset anonymize button state
            const anonymizeBtn = tabContent.querySelector(`#anonymizeBtn-${tabId}`);
            if (anonymizeBtn) {
                anonymizeBtn.disabled = false;
                anonymizeBtn.textContent = '🔒 Start Anonymization';
            }
            
            // Clear file inputs
            const fileInput = tabContent.querySelector(`#fileInputFiles-${tabId}`);
            if (fileInput) {
                fileInput.value = '';
            }
            const folderInput = tabContent.querySelector(`#fileInputFolder-${tabId}`);
            if (folderInput) {
                folderInput.value = '';
            }
            
            // Setup event handlers
            setupTabEventHandlers(tabId);
        }

        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            
            // Activate tab button
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            activeTab = tabId;
        }

        function closeTab(event, tabId) {
            event.stopPropagation();

            const tabButtons = document.querySelectorAll('.tab-button');
            let replacementTabId = null;
            if (tabButtons.length <= 1) {
                replacementTabId = createNewTab();
            }

            // Clean up session if exists
            const state = tabStates[tabId] || {};
            if (state.sessionId) {
                fetch(`/cleanup/${state.sessionId}`);
            }
            if (state.outputSessionId) {
                fetch(`/cleanup/${state.outputSessionId}`);
            }

            // Remove tab button and content
            const tabButtonEl = document.querySelector(`[data-tab="${tabId}"]`);
            if (tabButtonEl) {
                tabButtonEl.remove();
            }
            const tabContentEl = document.getElementById(tabId);
            if (tabContentEl) {
                tabContentEl.remove();
            }

            // Delete state
            delete tabStates[tabId];

            if (replacementTabId) {
                switchTab(replacementTabId);
                return;
            }

            // Switch to first available tab if this was active
            if (activeTab === tabId) {
                const firstTab = document.querySelector('.tab-button');
                if (firstTab) {
                    const firstTabId = firstTab.dataset.tab;
                    switchTab(firstTabId);
                }
            }
        }

        function setupTabEventHandlers(tabId) {
            const uploadArea = document.getElementById(`uploadArea-${tabId}`);
            if (!uploadArea) {
                return;
            }

            // Remove old listeners by cloning the upload area (including controls)
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);

            // Re-select fresh elements
            const finalUploadArea = document.getElementById(`uploadArea-${tabId}`);
            const finalFileInput = document.getElementById(`fileInputFiles-${tabId}`);
            const finalFolderInput = document.getElementById(`fileInputFolder-${tabId}`);
            const selectFilesBtn = document.getElementById(`selectFiles-${tabId}`);
            const selectFolderBtn = document.getElementById(`selectFolder-${tabId}`);

            if (!finalFileInput || !finalFolderInput) {
                return;
            }

            const triggerFilePicker = (inputElement) => {
                if (!finalUploadArea.classList.contains('disabled') && inputElement) {
                    inputElement.click();
                }
            };

            // Dedicated buttons for files/folders
            if (selectFilesBtn) {
                selectFilesBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    event.preventDefault();
                    triggerFilePicker(finalFileInput);
                });
            }

            if (selectFolderBtn) {
                selectFolderBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    event.preventDefault();
                    triggerFilePicker(finalFolderInput);
                });
            }

            // Drag and drop handlers
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, preventDefaults, false);
                finalUploadArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                finalUploadArea.addEventListener(eventName, (e) => highlight(e, tabId), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                finalUploadArea.addEventListener(eventName, (e) => unhighlight(e, tabId), false);
            });

            finalUploadArea.addEventListener('drop', (e) => handleDrop(e, tabId), false);
            finalFileInput.addEventListener('change', (e) => handleFileSelect(e, tabId));
            finalFolderInput.addEventListener('change', (e) => handleFileSelect(e, tabId));

            // Radio button handlers for anonymization mode
            document.querySelectorAll(`input[name="anonymizationMode-${tabId}"]`).forEach(radio => {
                radio.addEventListener('change', function() {
                    const standardOptions = document.getElementById(`standardOptions-${tabId}`);
                    if (this.value === 'standard') {
                        standardOptions.style.display = 'block';
                    } else {
                        standardOptions.style.display = 'none';
                    }
                });
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e, tabId) {
            const uploadArea = document.getElementById(`uploadArea-${tabId}`);
            if (!uploadArea.classList.contains('disabled')) {
                uploadArea.classList.add('drag-over');
                if (e.type === 'dragenter') {
                    uploadArea.classList.add('drag-active');
                }
            }
        }

        function unhighlight(e, tabId) {
            const uploadArea = document.getElementById(`uploadArea-${tabId}`);
            uploadArea.classList.remove('drag-over');
            if (e.type === 'drop') {
                uploadArea.classList.remove('drag-active');
            }
        }

        function readAllDirectoryEntries(reader) {
            return new Promise((resolve, reject) => {
                const entries = [];
                const readEntries = () => {
                    reader.readEntries(results => {
                        if (!results.length) {
                            resolve(entries);
                        } else {
                            entries.push(...results);
                            readEntries();
                        }
                    }, reject);
                };
                readEntries();
            });
        }

        async function traverseFileTree(entry, path = '') {
            if (entry.isFile) {
                return new Promise(resolve => {
                    entry.file(file => {
                        const relativePath = `${path}${file.name}`;
                        try {
                            Object.defineProperty(file, 'relativePath', { value: relativePath, configurable: true });
                            Object.defineProperty(file, 'webkitRelativePath', { value: relativePath, configurable: true });
                        } catch (err) {
                            file.relativePath = relativePath;
                            file.webkitRelativePath = relativePath;
                        }
                        resolve([file]);
                    }, () => resolve([]));
                });
            }

            if (entry.isDirectory) {
                const reader = entry.createReader();
                let entries = [];
                try {
                    entries = await readAllDirectoryEntries(reader);
                } catch (error) {
                    console.error('Error reading directory entries', error);
                    return [];
                }
                const childFiles = await Promise.all(entries.map(child => traverseFileTree(child, `${path}${entry.name}/`)));
                return childFiles.flat();
            }

            return [];
        }

        async function handleDrop(e, tabId) {
            const uploadArea = document.getElementById(`uploadArea-${tabId}`);
            if (uploadArea.classList.contains('disabled')) {
                return;
            }
            
            const dt = e.dataTransfer;
            let files = [];

            if (dt.items && dt.items.length) {
                const entryPromises = Array.from(dt.items)
                    .map(item => (typeof item.webkitGetAsEntry === 'function' ? item.webkitGetAsEntry() : null))
                    .filter(entry => entry);

                if (entryPromises.length) {
                    const traversed = await Promise.all(entryPromises.map(entry => traverseFileTree(entry)));
                    files = traversed.flat();
                }
            }

            if (!files.length && dt.files) {
                files = Array.from(dt.files);
            }

            if (files.length > 0) {
                uploadFiles(files, tabId);
            }
        }

        function handleFileSelect(e, tabId) {
            const files = Array.from(e.target.files);
            uploadFiles(files, tabId);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function uploadFiles(files = [], tabId) {
            if (files.length === 0) return;
            
            const state = tabStates[tabId];
            if (!state.uploadEnabled) {
                showStatus('⚠️ Upload is disabled. Please start a new batch.', 'warning', tabId);
                return;
            }

            const formData = new FormData();
            files.forEach(file => {
                formData.append('files', file);
                const relPath = file.webkitRelativePath || file.relativePath || '';
                formData.append('relative_paths', relPath);
            });
            
            // Include existing session ID if we're adding to a batch
            if (state.sessionId) {
                formData.append('session_id', state.sessionId);
            }

            showStatus('📤 Uploading files to batch...', 'info', tabId);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    },
                    body: formData
                });

                const result = await parseJsonResponse(response, 'Session expired. Please login to continue.');
                if (!result) {
                    anonymizeBtn.disabled = false;
                    anonymizeBtn.textContent = '🔒 Start Anonymization';
                    enableUploadForTab(tabId);
                    return;
                }

                if (result.success) {
                    // Update state
                    state.sessionId = result.session_id;
                    state.totalDicomCount = result.total_dicom_count;
                    
                    // Add new files to state
                    if (result.is_new_session) {
                        state.files = result.files;
                    } else {
                        state.files = state.files.concat(result.files);
                    }
                    
                    displayBatchInfo(tabId);
                    displayUploadedFiles(state.files, tabId);

                    if (state.totalDicomCount > 0) {
                        showStatus(`✅ Batch contains ${state.totalDicomCount} DICOM files. You can add more or start processing.`, 'success', tabId);
                        document.getElementById(`optionsCard-${tabId}`).classList.remove('hidden');
                    } else {
                        showStatus(`⚠️ No DICOM files detected in batch. Please add DICOM files.`, 'warning', tabId);
                    }
                } else {
                    showStatus(`❌ Upload failed: ${result.error}`, 'error', tabId);
                }
            } catch (error) {
                showStatus(`❌ Upload failed: ${error.message}`, 'error', tabId);
            }
        }

        function displayBatchInfo(tabId) {
            const state = tabStates[tabId];
            const batchInfo = document.getElementById(`batchInfo-${tabId}`);
            const batchStats = document.getElementById(`batchStats-${tabId}`);
            
            batchInfo.classList.remove('hidden');
            batchStats.innerHTML = `
                <p><strong>Session ID:</strong> ${state.sessionId.substring(0, 8)}...</p>
                <p><strong>Total DICOM Files:</strong> ${state.totalDicomCount}</p>
                <p><strong>Status:</strong> Ready for processing</p>
            `;
        }

        function displayUploadedFiles(files, tabId) {
            const fileList = document.getElementById(`fileList-${tabId}`);
            const batchFilesList = document.getElementById(`batchFilesList-${tabId}`);
            
            fileList.innerHTML = '<h4>📋 Files in Current Batch:</h4>';
            batchFilesList.innerHTML = '';

            if (files.length === 0) {
                fileList.innerHTML += '<p>No files in batch.</p>';
                return;
            }

            // Group files by directory/archive
            const fileGroups = {};
            files.forEach(file => {
                const groupKey = file.from_zip ? file.original_archive : 'Direct Upload';
                if (!fileGroups[groupKey]) {
                    fileGroups[groupKey] = [];
                }
                fileGroups[groupKey].push(file);
            });

            // Display grouped files
            Object.keys(fileGroups).forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.style.marginBottom = '15px';
                
                const groupHeader = document.createElement('h5');
                groupHeader.style.color = '#0066cc';
                groupHeader.textContent = group;
                groupDiv.appendChild(groupHeader);
                
                fileGroups[group].forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = `file-item ${file.is_dicom ? 'dicom' : 'non-dicom'}`;

                    const fileName = file.relative_path || file.name;
                    const fileStatus = file.is_dicom ? 'DICOM' : 'Not DICOM';
                    const fileIcon = file.is_dicom ? '🏥' : '📄';

                    fileItem.innerHTML = `
                        <span>${fileIcon} ${fileName}</span>
                        <span class="badge ${file.is_dicom ? 'dicom' : 'non-dicom'}">${fileStatus}</span>
                    `;
                    groupDiv.appendChild(fileItem);
                    
                    // Also add to batch files list (summary)
                    if (file.is_dicom) {
                        const summaryItem = document.createElement('div');
                        summaryItem.style.padding = '2px 5px';
                        summaryItem.innerHTML = `🏥 ${fileName}`;
                        batchFilesList.appendChild(summaryItem);
                    }
                });
                
                fileList.appendChild(groupDiv);
            });

            fileList.classList.remove('hidden');
        }

        function enableUploadForTab(tabId) {
            const uploadArea = document.getElementById(`uploadArea-${tabId}`);
            uploadArea.classList.remove('disabled');
            showStatus('📁 Upload enabled. Add more files to the batch.', 'info', tabId);
        }

        function disableUploadForTab(tabId) {
            const uploadArea = document.getElementById(`uploadArea-${tabId}`);
            uploadArea.classList.add('disabled');
            tabStates[tabId].uploadEnabled = false;
        }

        async function startAnonymization(tabId) {
            const state = tabStates[tabId];
            
            if (!state.sessionId) {
                showStatus('❌ No files uploaded', 'error', tabId);
                return;
            }

            // Disable upload area
            disableUploadForTab(tabId);

            const anonymizeBtn = document.getElementById(`anonymizeBtn-${tabId}`);
            anonymizeBtn.disabled = true;
            anonymizeBtn.textContent = '🔄 Anonymizing...';

            const keepPrivateTags = document.getElementById(`keepPrivateTags-${tabId}`).checked;
            const anonymizationMode = document.querySelector(`input[name="anonymizationMode-${tabId}"]:checked`)?.value || 'standard';

            showStatus('⚙️ Anonymizing DICOM files in batch...', 'info', tabId);

            try {
                const response = await fetch('/anonymize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: state.sessionId,
                        anonymization_mode: anonymizationMode,
                        keep_private_tags: keepPrivateTags,
                        custom_rules: {}
                    })
                });

                const result = await parseJsonResponse(response, 'Session expired. Please login to continue.');
                if (!result) {
                    return;
                }

                if (result.success) {
                    state.outputSessionId = result.output_session_id;
                    showAnonymizationResults(result, tabId);
                    // Reset button state after success
                    anonymizeBtn.disabled = false;
                    anonymizeBtn.textContent = '🔒 Start Anonymization';
                } else {
                    showStatus(`❌ Anonymization failed: ${result.error}`, 'error', tabId);
                    anonymizeBtn.disabled = false;
                    anonymizeBtn.textContent = '🔒 Start Anonymization';
                    enableUploadForTab(tabId);
                }
            } catch (error) {
                showStatus(`❌ Anonymization failed: ${error.message}`, 'error', tabId);
                anonymizeBtn.disabled = false;
                anonymizeBtn.textContent = '🔒 Start Anonymization';
                enableUploadForTab(tabId);
            }
        }

        function showAnonymizationResults(result, tabId) {
            const resultsStatus = document.getElementById(`resultsStatus-${tabId}`);
            
            // Build directory structure display
            let structureHtml = '';
            if (result.file_structure) {
                structureHtml = '<div class="directory-tree"><h5>📂 Preserved Structure:</h5>';
                Object.keys(result.file_structure).forEach(dir => {
                    if (dir === 'root') {
                        structureHtml += '<div class="directory-item">📁 /</div>';
                    } else {
                        structureHtml += `<div class="directory-item"><span class="directory-folder">📁 ${dir}/</span></div>`;
                    }
                    result.file_structure[dir].forEach(file => {
                        structureHtml += `<div class="directory-item directory-file">  └─ 🏥 ${file}</div>`;
                    });
                });
                structureHtml += '</div>';
            }
            
            resultsStatus.innerHTML = `
                <div class="status success">
                    ✅ Successfully anonymized ${result.count} DICOM files - Download starting automatically...
                </div>
                ${structureHtml}
                <div class="file-list">
                    <h4>🔒 Anonymized Files:</h4>
                    ${result.files.map(file => `
                        <div class="file-item dicom">
                            <span>🏥 ${file.anonymized}</span>
                            <span>✅ Anonymized</span>
                        </div>
                    `).join('')}
                </div>
            `;

            const downloadBtn = document.getElementById(`downloadBtn-${tabId}`);
            downloadBtn.onclick = () => downloadAnonymizedFiles(tabId);

            document.getElementById(`optionsCard-${tabId}`).classList.add('hidden');
            document.getElementById(`resultsCard-${tabId}`).classList.remove('hidden');

            // Automatically start download after a short delay
            setTimeout(() => {
                downloadAnonymizedFiles(tabId);
                // Update the status message after download starts
                const statusDiv = resultsStatus.querySelector('.status.success');
                if (statusDiv) {
                    statusDiv.innerHTML = '✅ Successfully anonymized ' + result.count + ' DICOM files - Download started!';
                }
            }, 1500);
        }

        function downloadAnonymizedFiles(tabId) {
            const state = tabStates[tabId];
            if (state.outputSessionId) {
                window.location.href = `/download/${state.outputSessionId}`;
                // Clean up after a delay
                setTimeout(() => {
                    fetch(`/cleanup/${state.outputSessionId}`);
                    fetch(`/cleanup/${state.sessionId}`);
                }, 3000);
            }
        }

        function startOver(tabId) {
            const state = tabStates[tabId];
            
            // Clean up sessions
            if (state.outputSessionId) {
                fetch(`/cleanup/${state.outputSessionId}`);
            }
            if (state.sessionId) {
                fetch(`/cleanup/${state.sessionId}`);
            }

            // Reset state
            tabStates[tabId] = createEmptyTabState();

            // Reset UI
            const tabContent = document.getElementById(tabId);
            
            // Reset anonymize button BEFORE resetTabContent
            const anonymizeBtn = document.getElementById(`anonymizeBtn-${tabId}`);
            if (anonymizeBtn) {
                anonymizeBtn.disabled = false;
                anonymizeBtn.textContent = '🔒 Start Anonymization';
            }
            
            resetTabContent(tabContent, tabId);
            
            // Clear file inputs
            const fileInput = document.getElementById(`fileInputFiles-${tabId}`);
            const folderInput = document.getElementById(`fileInputFolder-${tabId}`);
            if (fileInput) {
                fileInput.value = '';
            }
            if (folderInput) {
                folderInput.value = '';
            }
            
            // Hide all sections
            document.getElementById(`batchInfo-${tabId}`).classList.add('hidden');
            document.getElementById(`fileList-${tabId}`).classList.add('hidden');
            document.getElementById(`optionsCard-${tabId}`).classList.add('hidden');
            document.getElementById(`resultsCard-${tabId}`).classList.add('hidden');
            document.getElementById(`uploadStatus-${tabId}`).classList.add('hidden');
            document.getElementById(`uploadProgress-${tabId}`).classList.add('hidden');
            
            showStatus('🚀 Ready to upload a new batch of files.', 'info', tabId);
        }

        function showStatus(message, type, tabId) {
            const uploadStatus = document.getElementById(`uploadStatus-${tabId}`);
            if (!uploadStatus) {
                return;
            }
            uploadStatus.className = `status ${type}`;
            uploadStatus.innerHTML = message;
            uploadStatus.classList.remove('hidden');
        }

        function restoreExistingSessions(existingSessions = []) {
            if (!Array.isArray(existingSessions) || existingSessions.length === 0) {
                showStatus('🚀 Ready to upload DICOM files. Drag and drop or click to select files.', 'info', 'tab-1');
                return;
            }

            existingSessions.forEach((session, index) => {
                const targetTabId = index === 0 ? 'tab-1' : createNewTab();
                const state = tabStates[targetTabId];

                state.sessionId = session.session_id || null;
                state.files = Array.isArray(session.files) ? session.files : [];
                state.totalDicomCount = session.total_dicom_count || 0;
                state.uploadEnabled = true;
                state.outputSessionId = null;

                if (state.sessionId) {
                    displayBatchInfo(targetTabId);
                }

                if (state.files.length > 0) {
                    displayUploadedFiles(state.files, targetTabId);
                }

                if (state.totalDicomCount > 0) {
                    showStatus(`♻️ Restored batch with ${state.totalDicomCount} DICOM files.`, 'success', targetTabId);
                    const optionsCard = document.getElementById(`optionsCard-${targetTabId}`);
                    if (optionsCard) {
                        optionsCard.classList.remove('hidden');
                    }
                } else {
                    showStatus('Batch restored. Add DICOM files to continue.', 'info', targetTabId);
                }
            });

            switchTab('tab-1');
        }

        // Initialize first tab on page load
        window.addEventListener('load', () => {
            setupTabEventHandlers('tab-1');
            restoreExistingSessions(appConfig.existingSessions);
        });
    </script>
</body>
</html>